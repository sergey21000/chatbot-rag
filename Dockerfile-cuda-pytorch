FROM pytorch/pytorch:2.8.0-cuda12.9-cudnn9-devel AS builder

RUN apt-get update \
	&& apt-get install -y git ca-certificates \
	&& rm -rf /var/lib/apt/lists/*

ENV CUDA_DOCKER_ARCH="sm_75,sm_80,sm_86,sm_89,sm_90"
ENV GGML_CUDA=1
ENV CMAKE_ARGS="-DGGML_CUDA=on -DCMAKE_CUDA_ARCHITECTURES=75;80;86;89;90"

COPY requirements-base.txt requirements-cuda.txt .
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /app/wheels \
    -r requirements-base.txt $(grep -v '^torch' requirements-cuda.txt | tr -d '\r')

FROM pytorch/pytorch:2.8.0-cuda12.9-cudnn9-runtime

COPY --from=builder /app/wheels /wheels
RUN pip install --no-cache-dir /wheels/* && rm -rf /wheels

ENV LD_LIBRARY_PATH="/opt/conda/lib/python3.11/site-packages/nvidia/cuda_runtime/lib/:${LD_LIBRARY_PATH}"
ENV LD_LIBRARY_PATH="/opt/conda/lib/python3.11/site-packages/nvidia/cublas/lib/:${LD_LIBRARY_PATH}"

WORKDIR /app
COPY app.py config.py utils.py .

EXPOSE 7860
CMD ["python3", "app.py"]
